#!/bin/bash
set -e -x

location=$(dirname $0)
rootdir=$(realpath $location/..)
version=$1
targetdir=$rootdir/docs/charts/$version
helm_index=$rootdir/docs/charts/index.yaml

echo "Create target repo ${targetdir} ..."
mkdir -p $targetdir

cd $rootdir/charts


echo "Package camel-dashboard-console helm chart ${version} ..."
helm package ./camel-dashboard-console --version $version
mv camel-dashboard-console-*.tgz $targetdir/
echo "Index helm charts helm chart ${version} ..."
helm repo index $targetdir --url https://camel-tooling.github.io/camel-dashboard/charts/ --merge $helm_index
# Required to prevent https://github.com/helm/helm/issues/7363
mv $targetdir/* $targetdir/../.
rm -rf $targetdir